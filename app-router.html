<!-- Copyright (C) 2014 Erik Ringsmuth - MIT license -->
<script type="text/javascript">
!function(t,e){function i(t,i,r){var n=e.createEvent("CustomEvent");return n.initCustomEvent(t,!1,!0,i),r.dispatchEvent(n)}e.registerElement("app-route",{prototype:Object.create(HTMLElement.prototype)}),e.registerElement("active-route",{prototype:Object.create(HTMLElement.prototype)});var r=Object.create(HTMLElement.prototype),n={},a="ActiveXObject"in t;r.attachedCallback=function(){"manual"!==this.getAttribute("init")&&this.init()},r.init=function(){this.isInitialized||(this.isInitialized=!0,this.activeRoute=e.createElement("app-route"),this.stateChangeHandler=this.go.bind(this),t.addEventListener("popstate",this.stateChangeHandler,!1),a&&t.addEventListener("hashchange",this.stateChangeHandler,!1),this.activeRouteContent=e.createElement("active-route"),this.appendChild(this.activeRouteContent),this.hasAttribute("shadow")&&(this.activeRouteContent=this.activeRouteContent.createShadowRoot()),this.go())},r.detachedCallback=function(){t.removeEventListener("popstate",this.stateChangeHandler,!1),a&&t.removeEventListener("hashchange",this.stateChangeHandler,!1)},r.go=function(){var e=this.parseUrlPath(t.location.href,this.getAttribute("pathType")),r={path:e};if(i("state-change",r,this)){for(var n=this.firstElementChild;n;){if("APP-ROUTE"===n.tagName&&this.testRoute(n.getAttribute("path"),e,this.getAttribute("trailingSlash"),n.hasAttribute("regex")))return this.activateRoute(n,e),void 0;n=n.nextSibling}i("not-found",r,this)}},r.activateRoute=function(t,r){var n={path:r,route:t,oldRoute:this.activeRoute};i("activate-route-start",n,this)&&i("activate-route-start",n,t)&&(this.activeRoute.removeAttribute("active"),t.setAttribute("active","active"),this.activeRoute=t,t.hasAttribute("import")?this.importAndActivate(t.getAttribute("import"),t,r,n):t.hasAttribute("element")?this.activateCustomElement(t.getAttribute("element"),t,r,n):"TEMPLATE"===t.firstElementChild.tagName&&this.activeElement(e.importNode(t.firstElementChild.content,!0),n))},r.importAndActivate=function(t,i,r,a){if(n.hasOwnProperty(t)){var s=e.querySelector('link[href="'+t+'"]');s.import?this.activateImport(s.import,t,i,r,a):s.onload=function(){i.hasAttribute("active")&&this.activateImport(s.import,t,i,r,a)}.bind(this)}else{n[t]=!0;var o=e.createElement("link");o.setAttribute("rel","import"),o.setAttribute("href",t),o.onload=function(){i.hasAttribute("active")&&this.activateImport(o.import,t,i,r,a)}.bind(this),e.head.appendChild(o)}},r.activateImport=function(t,i,r,n,a){1===t.querySelector("html>head").children.length&&t.querySelector("html>head>template")&&0===t.querySelector("html>body").children.length?this.activeElement(e.importNode(t.querySelector("html>head>template").content,!0),a):this.activateCustomElement(r.getAttribute("element")||i.split("/").slice(-1)[0].replace(".html",""),r,n,a)},r.activateCustomElement=function(i,r,n,a){var s=e.createElement(i),o=this.routeArguments(r.getAttribute("path"),n,t.location.href,r.hasAttribute("regex"),this.getAttribute("pathType"));for(var h in o)o.hasOwnProperty(h)&&(s[h]=o[h]);this.activeElement(s,a)},r.activeElement=function(t,e){for(;this.activeRouteContent.firstChild;)this.activeRouteContent.removeChild(this.activeRouteContent.firstChild);this.activeRouteContent.appendChild(t),i("activate-route-end",e,this),i("activate-route-end",e,e.route)},r.parseUrlPath=function(t,e){var i=t.split("/"),r="/"+i.splice(3,i.length-3).join("/"),n=r.split(/[\?#]/)[0];if("regular"!==e){var a=r.indexOf("#");if(-1!==a){var s=r.substring(a).split("?")[0];"#/"===s.substring(0,2)?n=s.substring(1):"#!/"===s.substring(0,3)?n=s.substring(2):"hash"===e&&(n=s.substring(1))}}return n},r.testRoute=function(t,e,i,r){if("ignore"===i&&("/"===e.slice(-1)&&(e=e.slice(0,-1)),"/"!==t.slice(-1)||r||(t=t.slice(0,-1))),r){if("/"!==t.charAt(0))return!1;t=t.slice(1);var n="";if("/"===t.slice(-1))t=t.slice(0,-1);else{if("/i"!==t.slice(-2))return!1;t=t.slice(0,-2),n="i"}return new RegExp(t,n).test(e)}if(t===e||"*"===t)return!0;if(-1===t.indexOf("*")&&-1===t.indexOf(":"))return!1;var a=e.split("/"),s=t.split("/");if(a.length!==s.length)return!1;for(var o=0;o<s.length;o++){var h=s[o];if(h!==a[o]&&"*"!==h&&":"!==h.charAt(0))return!1}return!0},r.routeArguments=function(t,e,i,r,n){var a={},s=e.split("/");if(!r)for(var o=t.split("/"),h=0;h<o.length;h++){var l=o[h];":"===l.charAt(0)&&(a[l.substring(1)]=s[h])}var u=i.indexOf("?"),c="";if(-1!==u){c=i.substring(u);var v=c.indexOf("#");-1!==v&&(c=c.substring(0,v))}if("regular"!==n){var p=i.indexOf("#/"),d=i.indexOf("#!/");if(-1!==p||-1!==d){var m="";m=-1!==p?i.substring(p):i.substring(d),u=m.indexOf("?"),-1!==u&&(c=m.substring(u))}}var f=c.substring(1).split("&");1===f.length&&""===f[0]&&(f=[]);for(var g=0;g<f.length;g++){var b=f[g],A=b.split("=");a[A[0]]=A.splice(1,A.length-1).join("=")}for(var E in a){var C=a[E];a[E]="true"===C?!0:"false"===C?!1:isNaN(C)||""===C?decodeURIComponent(C):+C}return a},e.registerElement("app-router",{prototype:r})}(window,document);
</script>
